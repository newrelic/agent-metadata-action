name: Action Test

permissions:
  contents: write

on:
  push:
    branches:
      - '**'

jobs:
  setup-test-tag:
    name: Setup Test Tag
    runs-on: ubuntu-latest
    steps:
      - name: Checkout action repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Push temporary tag for testing
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git tag -f v0.0.0 HEAD
          git push -f origin v0.0.0

  test-agent-flow-no-v-version:
    needs: setup-test-tag
    name: Test Agent Repository Flow
    runs-on: ubuntu-latest
    steps:
      - name: Checkout action repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Agent Metadata Action (with configs)
        uses: ./
        with:
          agent-type: 'myagent'
          version: '0.0.0'
          cache: false

  test-agent-flow-v-version:
    needs: setup-test-tag
    name: Test Agent Repository Flow with "v" prefixed version
    runs-on: ubuntu-latest
    steps:
      - name: Checkout action repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Agent Metadata Action (with configs)
        uses: ./
        with:
          agent-type: 'myagent'
          version: 'v0.0.0'
          cache: false

  test-docs-flow:
    name: Test Documentation Flow (MDX Parsing)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout action repository
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version-file: 'go.mod'
          cache: true

      - name: Build action
        run: go build -o agent-metadata-action ./cmd/agent-metadata-action

      - name: Setup temporary workspace with MDX files
        run: |
          # Create a temporary directory for the test workspace
          TEMP_WORKSPACE="${{ runner.temp }}/test-workspace"
          mkdir -p "$TEMP_WORKSPACE"

          # Initialize git repo in temp workspace
          cd "$TEMP_WORKSPACE"
          git init
          git config user.email "test@example.com"
          git config user.name "Test User"

          # Create base commit (without MDX files)
          mkdir -p src/content/docs/release-notes
          git commit --allow-empty -m "Initial commit"
          BASE_SHA=$(git rev-parse HEAD)

          # Copy integration-test MDX files and commit them
          cp -r "${{ github.workspace }}/integration-test/docs-flow/"* .
          git add .
          git commit -m "Add release notes"
          HEAD_SHA=$(git rev-parse HEAD)

          # Create mock PR event
          cat > /tmp/pr-event.json <<EOF
          {
            "pull_request": {
              "base": {"sha": "${BASE_SHA}"},
              "head": {"sha": "${HEAD_SHA}"}
            }
          }
          EOF

          echo "BASE_SHA: $BASE_SHA"
          echo "HEAD_SHA: $HEAD_SHA"
          echo "TEMP_WORKSPACE=$TEMP_WORKSPACE" >> $GITHUB_ENV

      - name: Run Agent Metadata Action (metadata from MDX)
        env:
          GITHUB_EVENT_PATH: '/tmp/pr-event.json'
          GITHUB_WORKSPACE: ${{ env.TEMP_WORKSPACE }}
        run: |
          cd ${{ env.TEMP_WORKSPACE }}
          ${{ github.workspace }}/agent-metadata-action

  cleanup-test-tag:
    name: Cleanup Test Tag
    runs-on: ubuntu-latest
    needs: [test-agent-flow-no-v-version, test-agent-flow-v-version, test-docs-flow]
    if: always()
    steps:
      - name: Checkout action repository
        uses: actions/checkout@v4

      - name: Delete temporary tag
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git push origin :refs/tags/v0.0.0 || true
