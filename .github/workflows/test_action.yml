name: Action Test

permissions:
  contents: write

on:
  push:
    branches:
      - '**'

jobs:
  setup-test-tag:
    name: Setup Test Tag
    runs-on: ubuntu-latest
    steps:
      - name: Checkout action repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Push temporary tag for testing
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git tag -f v0.0.0 HEAD
          git push -f origin v0.0.0

  test-agent-flow-no-v-version:
    needs: setup-test-tag
    name: Test Agent Repository Flow
    runs-on: ubuntu-latest
    steps:
      - name: Checkout action repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Start mock metadata service
        run: |
          # Start mock HTTP server for metadata service
          node .github/mock-server.js 8080 > mock-server.log 2>&1 &
          echo $! > mock-server.pid

          # Wait for server to be ready
          sleep 2

          # Verify server is running
          if ! curl -f http://127.0.0.1:8080/ > /dev/null 2>&1; then
            echo "Mock server failed to start"
            cat mock-server.log
            exit 1
          fi

          echo "Mock metadata service is running on port 8080"

      - name: Setup mock newrelic-auth-cli
        run: |
          # Make our mock CLI executable
          chmod +x .github/mock-newrelic-auth-cli

          # Add to PATH so it's found before any real installation
          echo "${{ github.workspace }}/.github" >> $GITHUB_PATH

      - name: Run Agent Metadata Action (with configs)
        uses: ./
        env:
          METADATA_SERVICE_URL: http://127.0.0.1:8080
        with:
          newrelic-client-id: fake-client-id-for-testing
          newrelic-private-key: fake-private-key-for-testing
          agent-type: 'myagent'
          version: '0.0.0'
          cache: false

      - name: Show mock server logs
        if: always()
        run: |
          echo "=== Mock Server Logs ==="
          cat mock-server.log || echo "No logs found"

      - name: Cleanup mock server
        if: always()
        run: |
          if [ -f mock-server.pid ]; then
            kill $(cat mock-server.pid) || true
            rm mock-server.pid
          fi

  test-agent-flow-v-version:
    needs: setup-test-tag
    name: Test Agent Repository Flow with "v" prefixed version
    runs-on: ubuntu-latest
    steps:
      - name: Checkout action repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Start mock metadata service
        run: |
          # Start mock HTTP server for metadata service
          node .github/mock-server.js 8080 > mock-server.log 2>&1 &
          echo $! > mock-server.pid

          # Wait for server to be ready
          sleep 2

          # Verify server is running
          if ! curl -f http://127.0.0.1:8080/ > /dev/null 2>&1; then
            echo "Mock server failed to start"
            cat mock-server.log
            exit 1
          fi

          echo "Mock metadata service is running on port 8080"

      - name: Setup mock newrelic-auth-cli
        run: |
          # Make our mock CLI executable
          chmod +x .github/mock-newrelic-auth-cli

          # Add to PATH so it's found before any real installation
          echo "${{ github.workspace }}/.github" >> $GITHUB_PATH

      - name: Run Agent Metadata Action (with configs)
        uses: ./
        env:
          METADATA_SERVICE_URL: http://127.0.0.1:8080
        with:
          newrelic-client-id: fake-client-id-for-testing
          newrelic-private-key: fake-private-key-for-testing
          agent-type: 'myagent'
          version: 'v0.0.0'
          cache: false

      - name: Show mock server logs
        if: always()
        run: |
          echo "=== Mock Server Logs ==="
          cat mock-server.log || echo "No logs found"

      - name: Cleanup mock server
        if: always()
        run: |
          if [ -f mock-server.pid ]; then
            kill $(cat mock-server.pid) || true
            rm mock-server.pid
          fi

  # TODO: Re-enable docs flow test once metadata service call is implemented for docs workflow
  # test-docs-flow:
  #   name: Test Documentation Flow (MDX Parsing)
  #   runs-on: ubuntu-latest
  #   steps:
  #     - name: Checkout action repository
  #       uses: actions/checkout@v4
  #       with:
  #         fetch-depth: 0  # Need full history to create proper PR simulation

  #     - name: Create mock PR event with real commits
  #       run: |
  #         # Create two commits: one without MDX files, one with them
  #         # This simulates a PR that adds MDX files

  #         # Create base commit (remove MDX files temporarily)
  #         TEMP_BACKUP="${{ runner.temp }}/mdx-backup"
  #         mkdir -p "$TEMP_BACKUP"

  #         if [ -d "integration-test/docs-flow" ]; then
  #           cp -r integration-test/docs-flow "$TEMP_BACKUP/"
  #           rm -rf integration-test/docs-flow
  #         fi

  #         git config user.email "test@example.com"
  #         git config user.name "Test User"
  #         git add -A
  #         git commit -m "Base commit without MDX files" || echo "No changes to commit"
  #         BASE_SHA=$(git rev-parse HEAD)

  #         # Restore MDX files and create head commit
  #         if [ -d "$TEMP_BACKUP/docs-flow" ]; then
  #           mkdir -p integration-test
  #           cp -r "$TEMP_BACKUP/docs-flow" integration-test/
  #         fi

  #         git add -A
  #         git commit -m "Add release notes MDX files"
  #         HEAD_SHA=$(git rev-parse HEAD)

  #         # Create mock PR event
  #         cat > /tmp/pr-event.json <<EOF
  #         {
  #           "pull_request": {
  #             "base": {"sha": "${BASE_SHA}"},
  #             "head": {"sha": "${HEAD_SHA}"}
  #           }
  #         }
  #         EOF

  #         echo "BASE_SHA: $BASE_SHA"
  #         echo "HEAD_SHA: $HEAD_SHA"

  #         # Verify the MDX files exist
  #         echo "MDX files that will be detected as changed:"
  #         git diff --name-only ${BASE_SHA} ${HEAD_SHA} | grep -E '\.mdx$' || echo "No MDX files found"

  #     - name: Run Agent Metadata Action (metadata from MDX)
  #       uses: ./
  #       env:
  #         GITHUB_EVENT_PATH: '/tmp/pr-event.json'
  #       with:
  #         newrelic-client-id: ${{ secrets.OAUTH_CLIENT_ID }}
  #         newrelic-private-key: ${{ secrets.OAUTH_CLIENT_SECRET }}
  #         cache: false

  cleanup-test-tag:
    name: Cleanup Test Tag
    runs-on: ubuntu-latest
    # TODO: Add test-docs-flow back to needs when re-enabled
    needs: [test-agent-flow-no-v-version, test-agent-flow-v-version] # , test-docs-flow
    if: always()
    steps:
      - name: Checkout action repository
        uses: actions/checkout@v4

      - name: Delete temporary tag
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git push origin :refs/tags/v0.0.0 || true
