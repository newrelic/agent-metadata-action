name: Action Test

permissions:
  contents: write

on:
  push:
    branches:
      - '**'
  pull_request:
    branches:
      - '**'
  schedule:
    - cron: '0 1 * * *' # This runs the workflow daily at 1am UTC

jobs:
  setup-test-tag:
    name: Setup Test Tag
    runs-on: ubuntu-latest
    steps:
      - name: Checkout action repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Copy test .fleetControl to root for tagging
        run: |
          # Copy .fleetControl so it's included in the v0.0.0 tag
          cp -r integration-test/agent-flow/.fleetControl .
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          # Force add despite .gitignore
          git add -f .fleetControl
          git commit -m "Temporary: Add .fleetControl for testing"

      - name: Push temporary tag for testing
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git tag -f v0.0.0 HEAD
          git push -f origin v0.0.0

  test-agent-flow-no-v-version:
    needs: setup-test-tag
    name: Test Agent Repository Flow
    runs-on: ubuntu-latest
    steps:
      - name: Checkout action repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Start mock metadata service
        run: |
          # Start mock HTTP server for metadata service
          node .github/mock-server.js 8080 > mock-server.log 2>&1 &
          echo $! > mock-server.pid

          # Wait for server to be ready (increased for reliability on busy runners)
          sleep 5

          # Verify server is running
          if ! curl -f http://127.0.0.1:8080/ > /dev/null 2>&1; then
            echo "Mock server failed to start"
            cat mock-server.log
            exit 1
          fi

          echo "Mock metadata service is running on port 8080"

      - name: Setup mock newrelic-auth-cli
        run: |
          # Make our mock CLI executable and install to standard location
          chmod +x .github/mock-newrelic-auth-cli
          sudo cp .github/mock-newrelic-auth-cli /usr/local/bin/newrelic-auth-cli

          # Verify it's accessible
          which newrelic-auth-cli
          newrelic-auth-cli --help || echo "Mock CLI is ready"

      - name: Run Agent Metadata Action (with configs)
        uses: ./
        env:
          METADATA_SERVICE_URL: http://127.0.0.1:8080
          MOCK_NEWRELIC_AUTH_CLI: true
        with:
          newrelic-client-id: fake-client-id-for-testing
          newrelic-private-key: ZmFrZS1wcml2YXRlLWtleS1mb3ItdGVzdGluZwo=
          agent-type: 'myagent'
          version: '0.0.0'
          cache: false

      - name: Show mock server logs
        if: always()
        run: |
          echo "=== Mock Server Logs ==="
          cat mock-server.log || echo "No logs found"

      - name: Cleanup mock server
        if: always()
        run: |
          if [ -f mock-server.pid ]; then
            kill $(cat mock-server.pid) || true
            rm mock-server.pid
          fi

  test-agent-flow-v-version:
    needs: setup-test-tag
    name: Test Agent Repository Flow with "v" prefixed version
    runs-on: ubuntu-latest
    services:
      registry:
        image: registry:2
        ports:
          - 5000:5000
    steps:
      - name: Checkout action repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Start mock metadata service
        run: |
          # Start mock HTTP server for metadata service
          node .github/mock-server.js 8080 > mock-server.log 2>&1 &
          echo $! > mock-server.pid

          # Wait for server to be ready (increased for reliability on busy runners)
          sleep 5

          # Verify server is running
          if ! curl -f http://127.0.0.1:8080/ > /dev/null 2>&1; then
            echo "Mock server failed to start"
            cat mock-server.log
            exit 1
          fi

          echo "Mock metadata service is running on port 8080"

      - name: Setup mock newrelic-auth-cli
        run: |
          # Make our mock CLI executable and install to standard location
          chmod +x .github/mock-newrelic-auth-cli
          sudo cp .github/mock-newrelic-auth-cli /usr/local/bin/newrelic-auth-cli

          # Verify it's accessible
          which newrelic-auth-cli
          newrelic-auth-cli --help || echo "Mock CLI is ready"

      - name: Create test binary artifacts
        run: |
          echo "::group::Creating test binary files"
          mkdir -p dist

          # Create a temporary directory with test content to tar
          mkdir -p /tmp/test-agent
          echo "This is a test binary for OCI upload - $(date)" > /tmp/test-agent/README.txt
          echo "agent_version: v0.0.0" > /tmp/test-agent/metadata.txt

          # Create actual tar.gz archive
          tar -czf dist/test-agent-binary.tar.gz -C /tmp test-agent

          echo "::endgroup::"

      - name: Run Agent Metadata Action (with configs)
        uses: ./
        env:
          METADATA_SERVICE_URL: http://127.0.0.1:8080
          SIGNING_SERVICE_URL: http://127.0.0.1:8080
          MOCK_NEWRELIC_AUTH_CLI: true
        with:
          newrelic-client-id: fake-client-id-for-testing
          newrelic-private-key: ZmFrZS1wcml2YXRlLWtleS1mb3ItdGVzdGluZwo=
          agent-type: 'myagent'
          version: 'v0.0.0'
          cache: false
          oci-registry: 'localhost:5000/test-agents'
          oci-username: ''
          oci-password: ''
          binaries: '[{"name": "test-readme", "path": "./README.md", "os": "linux", "arch": "amd64", "format": "tar+gzip"}]'

      - name: Verify OCI upload to local registry
        run: |
          echo "::group::Verifying uploaded artifact in local registry"

          # Check if the manifest exists in the registry
          MANIFEST_URL="http://localhost:5000/v2/test-agents/manifests/v0.0.0"

          echo "Listing all tags in test-agents repository:"
          curl -s -f "http://localhost:5000/v2/test-agents/tags/list" | jq '.'
          echo ""

          echo "=== Manifest Index (v0.0.0 tag) ==="
          # Fetch manifest index with proper OCI accept header
          curl -s -f -H "Accept: application/vnd.oci.image.index.v1+json" \
            "$MANIFEST_URL" | jq '.'

          # Extract the digest of the actual artifact from the index
          ARTIFACT_DIGEST=$(curl -s -f -H "Accept: application/vnd.oci.image.index.v1+json" \
            "$MANIFEST_URL" | jq -r '.manifests[0].digest')

          if [ -n "$ARTIFACT_DIGEST" ] && [ "$ARTIFACT_DIGEST" != "null" ]; then
            echo ""
            echo "=== Artifact Manifest ($ARTIFACT_DIGEST) ==="
            # Fetch artifact manifest by digest
            curl -s -f -H "Accept: application/vnd.oci.image.manifest.v1+json" \
              "http://localhost:5000/v2/test-agents/manifests/$ARTIFACT_DIGEST" | jq '.'
          else
            echo "Warning: Could not extract artifact digest from index"
          fi

          echo "::endgroup::"

      - name: Show mock server logs
        if: always()
        run: |
          echo "=== Mock Server Logs ==="
          cat mock-server.log || echo "No logs found"

      - name: Cleanup mock server
        if: always()
        run: |
          if [ -f mock-server.pid ]; then
            kill $(cat mock-server.pid) || true
            rm mock-server.pid
          fi

  test-docs-flow:
    name: Test Documentation Flow (MDX Parsing)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout action repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need full history to create proper push simulation

      - name: Start mock metadata service
        run: |
          # Start mock HTTP server for metadata service
          node .github/mock-server.js 8080 > mock-server.log 2>&1 &
          echo $! > mock-server.pid

          # Wait for server to be ready (increased for reliability on busy runners)
          sleep 5

          # Verify server is running
          if ! curl -f http://127.0.0.1:8080/ > /dev/null 2>&1; then
            echo "Mock server failed to start"
            cat mock-server.log
            exit 1
          fi

          echo "Mock metadata service is running on port 8080"

      - name: Setup mock newrelic-auth-cli
        run: |
          # Make our mock CLI executable and install to standard location
          chmod +x .github/mock-newrelic-auth-cli
          sudo cp .github/mock-newrelic-auth-cli /usr/local/bin/newrelic-auth-cli

          # Verify it's accessible
          which newrelic-auth-cli
          newrelic-auth-cli --help || echo "Mock CLI is ready"

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version-file: 'go.mod'
          cache: false

      - name: Create fake commits and run action (docs flow)
        env:
          GITHUB_WORKSPACE: ${{ github.workspace }}
          METADATA_SERVICE_URL: http://127.0.0.1:8080
          NEWRELIC_TOKEN: fake-token-for-testing
        run: |
          echo "::group::Create fake commits"
          # Create two isolated commits: one without MDX files, one with them
          # This simulates a push that adds MDX files, isolated from real push changes

          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          # Backup MDX files
          TEMP_BACKUP="${{ runner.temp }}/mdx-backup"
          mkdir -p "$TEMP_BACKUP"

          if [ -d "integration-test/docs-flow" ]; then
            cp -r integration-test/docs-flow "$TEMP_BACKUP/"
            rm -rf integration-test/docs-flow
            git add -A
            # Always create a commit, even if no changes (ensures clean baseline)
            git commit -m "Before commit without MDX files" --allow-empty
          else
            # If docs-flow doesn't exist, create empty commit as baseline
            git commit -m "Before commit without MDX files" --allow-empty
          fi
          BEFORE_SHA=$(git rev-parse HEAD)

          # Restore MDX files and create "after" commit
          if [ -d "$TEMP_BACKUP/docs-flow" ]; then
            mkdir -p integration-test
            cp -r "$TEMP_BACKUP/docs-flow" integration-test/
            git add -A
            git commit -m "Add release notes MDX files"
          else
            echo "::error::Failed to backup docs-flow - cannot create test commits"
            exit 1
          fi
          AFTER_SHA=$(git rev-parse HEAD)

          echo "BEFORE_SHA: $BEFORE_SHA"
          echo "AFTER_SHA: $AFTER_SHA"

          # Verify the MDX files exist and show what will be detected
          echo "MDX files that will be detected as changed:"
          git diff --name-only ${BEFORE_SHA} ${AFTER_SHA} | grep -E '\.mdx$' || echo "::warning::No MDX files found in diff"
          echo "::endgroup::"

          echo "::group::Building action"
          go build -o agent-metadata-action ./cmd/agent-metadata-action
          echo "::endgroup::"

          echo "::group::Overwrite event file and verify"
          # Overwrite GitHub's event file with our fake push event IN THE SAME STEP
          # GitHub Actions resets this between steps, so we must do it right before running
          cat > "${GITHUB_EVENT_PATH}" <<EOF
          {
            "ref": "refs/heads/main",
            "before": "${BEFORE_SHA}",
            "after": "${AFTER_SHA}"
          }
          EOF

          echo "GITHUB_EVENT_PATH=${GITHUB_EVENT_PATH}"
          echo "Contents of event file (should have our fake SHAs):"
          cat "${GITHUB_EVENT_PATH}"
          echo "::endgroup::"

          echo "::group::Running action (docs flow - no agent-type or version)"
          ./agent-metadata-action
          echo "::endgroup::"

      - name: Show mock server logs
        if: always()
        run: |
          echo "=== Mock Server Logs ==="
          cat mock-server.log || echo "No logs found"

      - name: Cleanup mock server
        if: always()
        run: |
          if [ -f mock-server.pid ]; then
            kill $(cat mock-server.pid) || true
            rm mock-server.pid
          fi

  cleanup-test-tag:
    name: Cleanup Test Tag
    runs-on: ubuntu-latest
    needs: [test-agent-flow-no-v-version, test-agent-flow-v-version, test-docs-flow]
    if: always()
    steps:
      - name: Checkout action repository
        uses: actions/checkout@v4

      - name: Delete temporary tag
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git push origin :refs/tags/v0.0.0 || true
