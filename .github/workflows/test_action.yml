name: Action Test

permissions:
  contents: write

on:
  push:
    branches:
      - '**'

jobs:
  setup-test-tag:
    name: Setup Test Tag
    runs-on: ubuntu-latest
    steps:
      - name: Checkout action repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Push temporary tag for testing
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git tag -f v0.0.0 HEAD
          git push -f origin v0.0.0

  test-agent-flow-no-v-version:
    needs: setup-test-tag
    name: Test Agent Repository Flow
    runs-on: ubuntu-latest
    steps:
      - name: Checkout action repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Start mock metadata service
        run: |
          # Start mock HTTP server for metadata service
          node .github/mock-server.js 8080 > mock-server.log 2>&1 &
          echo $! > mock-server.pid

          # Wait for server to be ready
          sleep 2

          # Verify server is running
          if ! curl -f http://127.0.0.1:8080/ > /dev/null 2>&1; then
            echo "Mock server failed to start"
            cat mock-server.log
            exit 1
          fi

          echo "Mock metadata service is running on port 8080"

      - name: Setup mock newrelic-auth-cli
        run: |
          # Make our mock CLI executable and install to standard location
          chmod +x .github/mock-newrelic-auth-cli
          sudo cp .github/mock-newrelic-auth-cli /usr/local/bin/newrelic-auth-cli

          # Verify it's accessible
          which newrelic-auth-cli
          newrelic-auth-cli --help || echo "Mock CLI is ready"

      - name: Run Agent Metadata Action (with configs)
        uses: ./
        env:
          METADATA_SERVICE_URL: http://127.0.0.1:8080
          MOCK_NEWRELIC_AUTH_CLI: true
        with:
          newrelic-client-id: fake-client-id-for-testing
          newrelic-private-key: ZmFrZS1wcml2YXRlLWtleS1mb3ItdGVzdGluZwo=
          agent-type: 'myagent'
          version: '0.0.0'
          cache: false

      - name: Show mock server logs
        if: always()
        run: |
          echo "=== Mock Server Logs ==="
          cat mock-server.log || echo "No logs found"

      - name: Cleanup mock server
        if: always()
        run: |
          if [ -f mock-server.pid ]; then
            kill $(cat mock-server.pid) || true
            rm mock-server.pid
          fi

  test-agent-flow-v-version:
    needs: setup-test-tag
    name: Test Agent Repository Flow with "v" prefixed version
    runs-on: ubuntu-latest
    steps:
      - name: Checkout action repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Start mock metadata service
        run: |
          # Start mock HTTP server for metadata service
          node .github/mock-server.js 8080 > mock-server.log 2>&1 &
          echo $! > mock-server.pid

          # Wait for server to be ready
          sleep 2

          # Verify server is running
          if ! curl -f http://127.0.0.1:8080/ > /dev/null 2>&1; then
            echo "Mock server failed to start"
            cat mock-server.log
            exit 1
          fi

          echo "Mock metadata service is running on port 8080"

      - name: Setup mock newrelic-auth-cli
        run: |
          # Make our mock CLI executable and install to standard location
          chmod +x .github/mock-newrelic-auth-cli
          sudo cp .github/mock-newrelic-auth-cli /usr/local/bin/newrelic-auth-cli

          # Verify it's accessible
          which newrelic-auth-cli
          newrelic-auth-cli --help || echo "Mock CLI is ready"

      - name: Run Agent Metadata Action (with configs)
        uses: ./
        env:
          METADATA_SERVICE_URL: http://127.0.0.1:8080
          MOCK_NEWRELIC_AUTH_CLI: true
        with:
          newrelic-client-id: fake-client-id-for-testing
          newrelic-private-key: ZmFrZS1wcml2YXRlLWtleS1mb3ItdGVzdGluZwo=
          agent-type: 'myagent'
          version: 'v0.0.0'
          cache: false

      - name: Show mock server logs
        if: always()
        run: |
          echo "=== Mock Server Logs ==="
          cat mock-server.log || echo "No logs found"

      - name: Cleanup mock server
        if: always()
        run: |
          if [ -f mock-server.pid ]; then
            kill $(cat mock-server.pid) || true
            rm mock-server.pid
          fi

  test-docs-flow:
    name: Test Documentation Flow (MDX Parsing)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout action repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need full history to create proper push simulation

      - name: Start mock metadata service
        run: |
          # Start mock HTTP server for metadata service
          node .github/mock-server.js 8080 > mock-server.log 2>&1 &
          echo $! > mock-server.pid

          # Wait for server to be ready
          sleep 2

          # Verify server is running
          if ! curl -f http://127.0.0.1:8080/ > /dev/null 2>&1; then
            echo "Mock server failed to start"
            cat mock-server.log
            exit 1
          fi

          echo "Mock metadata service is running on port 8080"

      - name: Setup mock newrelic-auth-cli
        run: |
          # Make our mock CLI executable and install to standard location
          chmod +x .github/mock-newrelic-auth-cli
          sudo cp .github/mock-newrelic-auth-cli /usr/local/bin/newrelic-auth-cli

          # Verify it's accessible
          which newrelic-auth-cli
          newrelic-auth-cli --help || echo "Mock CLI is ready"

      - name: Create mock push event with real commits
        run: |
          # Create two commits: one without MDX files, one with them
          # This simulates a push that adds MDX files

          # Create "before" commit (remove MDX files temporarily)
          TEMP_BACKUP="${{ runner.temp }}/mdx-backup"
          mkdir -p "$TEMP_BACKUP"

          if [ -d "integration-test/docs-flow" ]; then
            cp -r integration-test/docs-flow "$TEMP_BACKUP/"
            rm -rf integration-test/docs-flow
          fi

          git config user.email "test@example.com"
          git config user.name "Test User"
          git add -A
          git commit -m "Before commit without MDX files" || echo "No changes to commit"
          BEFORE_SHA=$(git rev-parse HEAD)

          # Restore MDX files and create "after" commit
          if [ -d "$TEMP_BACKUP/docs-flow" ]; then
            mkdir -p integration-test
            cp -r "$TEMP_BACKUP/docs-flow" integration-test/
          fi

          git add -A
          git commit -m "Add release notes MDX files"
          AFTER_SHA=$(git rev-parse HEAD)

          echo "BEFORE_SHA: $BEFORE_SHA"
          echo "AFTER_SHA: $AFTER_SHA"

          # Verify the MDX files exist
          echo "MDX files that will be detected as changed:"
          git diff --name-only ${BEFORE_SHA} ${AFTER_SHA} | grep -E '\.mdx$' || echo "No MDX files found"

          # Push commits to temporary branch so they're available when action checks out
          TEMP_BRANCH="docs-flow-test-${GITHUB_RUN_ID}"
          git push origin HEAD:refs/heads/${TEMP_BRANCH}
          echo "TEMP_BRANCH=${TEMP_BRANCH}" >> $GITHUB_ENV

          # Create mock push event
          cat > /tmp/push-event.json <<EOF
          {
            "ref": "refs/heads/${TEMP_BRANCH}",
            "before": "${BEFORE_SHA}",
            "after": "${AFTER_SHA}"
          }
          EOF

      - name: Run Agent Metadata Action (metadata from MDX)
        uses: ./
        env:
          GITHUB_EVENT_PATH: '/tmp/push-event.json'
          METADATA_SERVICE_URL: http://127.0.0.1:8080
          MOCK_NEWRELIC_AUTH_CLI: true
        with:
          newrelic-client-id: fake-client-id-for-testing
          newrelic-private-key: ZmFrZS1wcml2YXRlLWtleS1mb3ItdGVzdGluZwo=
          cache: false

      - name: Show mock server logs
        if: always()
        run: |
          echo "=== Mock Server Logs ==="
          cat mock-server.log || echo "No logs found"

      - name: Cleanup mock server
        if: always()
        run: |
          if [ -f mock-server.pid ]; then
            kill $(cat mock-server.pid) || true
            rm mock-server.pid
          fi

      - name: Cleanup temporary branch
        if: always()
        run: |
          if [ -n "$TEMP_BRANCH" ]; then
            git push origin --delete $TEMP_BRANCH || true
          fi

  cleanup-test-tag:
    name: Cleanup Test Tag
    runs-on: ubuntu-latest
    needs: [test-agent-flow-no-v-version, test-agent-flow-v-version, test-docs-flow]
    if: always()
    steps:
      - name: Checkout action repository
        uses: actions/checkout@v4

      - name: Delete temporary tag
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git push origin :refs/tags/v0.0.0 || true
